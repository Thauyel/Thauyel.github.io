"use strict";function PersonalResponsiveMenuInit(e){window[e]=this;var n,s,t,o,a,i,l,r,c,g,d,u=this,p=jQuery(window),m=0,w=0,M=0,C=0,h=0,y=0;function f(e){jQuery.ajax({type:"GET",url:t.personalMessageSourceUrl,success:function(n){c=n,g=new Date,u.updateMessageCounterBasedOnCookie(),e&&S(n)},error:CommonFunctions.alertAjaxError})}function S(e){n.messageDialogContent.empty().html(e);var t={x:-(n.inboxMenuLink.width()/2+ +n.inboxMenuLink.css("padding-right").replace("px","")+ +n.inboxMenuLink.css("border-right-width").replace("px","")+ +n.inboxMenuLink.css("margin-right").replace("px","")),y:-(n.inboxMenuLink.height()/2+ +n.inboxMenuLink.css("padding-bottom").replace("px","")+ +n.inboxMenuLink.css("border-bottom-width").replace("px","")+ +n.inboxMenuLink.css("margin-bottom").replace("px",""))};s.isModernMainMenuEnabled&&(i.toggleArrow(!1),i.mainContainer.addClass("itsl-legacymessages-popup-modern-menu")),i.openDialogAt(t.x,t.y,!0),s.isAndroidBrowser||v(),_(n.inboxMenuLink.closest("li"),!0),T(),x()}function I(){l&&clearTimeout(l),l=setTimeout(v,200)}function v(){var e=n.messageDialogContent,s=p.height()-e.offset().top-(e.outerHeight(!0)-e.height());e.css({"max-height":s<0?0:s,"overflow-y":"auto"})}function k(e,s){E(e,n.notificationLink,n.notificationsBadge,!!s)}function Q(e,s){E(e,n.emailMenuLink,n.emailBadge,!!s)}function b(e,s){E(e,n.inboxMenuLink,n.messagesBadge,!!s)}function j(e,s){E(e,n.office365CloudEmailIconLink,n.office365CloudEmailBadge,!!s)}function L(e,s){E(e,n.gmailCloudEmailIconLink,n.gmailCloudEmailBadge,!!s)}function E(e,n,s,t){_(n.closest("li"),t),s.text(D(e,!0)),s.toggle(e>0)}function _(e,n){e.toggleClass(o.opaque,n)}function x(){n.messageDialogContent.find("#"+s.messageCounterIds.internalMessagesCounter).text(R(D(h)))}function T(){var e;window.itslearning.settings.app.is_instant_message_system_enabled||(e=s.primaryCloudEmailType===CloudEmailType.office365?R(D(M,!1)):R(D(C,!1)),n.messageDialogContent.find("#"+s.messageCounterIds.cloudMessagesCounter).text(e))}function D(e,n){return void 0===e||e<=0?"":n&&e>=100?"99+":e}function R(e){return""===e?"":" ("+e+")"}return u.initialize=function(){n=u.controls,s=u.settings,u.settings.terms,t=u.settings.urls,o=u.settings.cssClasses,a=u.settings.queryStringParameters,d=u.toggleMenuLinkFunction,n.personalMenuLink.on("click",function(){"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click(),d()});var e,l,m,w,M,C,h=document.querySelector("button[name=closePersonalMenu]");h&&h.addEventListener("click",function(){n.personalMenuDropDown.hide(),d(),n.personalMenuLink.focus()}),e=s.isIos,l=n.personalMenuLink,m=n.personalMenuDropDown,w=d,M=e?"touchstart":"click",C=m.find("li:first-child > button"),m.find("a").click(function(){m.hide(),w&&w()}),l.on(M+" keydown",function(e){(e.type===M||e.which===CCL.CommonConstants.keyCodes.arrowDown)&&("false"===$(".c-messages-popup").attr("aria-hidden")&&$(".c-messages__overlay").click(),m.toggle(),C.focus())}),$(document).on(M+" "+CCL.CommonTriggers.clickInInnerFrame,function(e){if(m.is(":visible")){var n=e.target,s=$(n),t=n===l.get(0)||1===s.closest(l).length,o=!t&&(n===m.get(0)||1===s.closest(m).length),a=m.find("li:last-child > a");t||o||(m.hide(),w&&w()),a.keydown(n,function(e){e.which!==CCL.CommonConstants.keyCodes.tab||e.shiftKey||(e.preventDefault(),C.focus())}),C.keydown(n,function(e){e.shiftKey&&e.which===CCL.CommonConstants.keyCodes.tab&&(e.preventDefault(),a.focus())})}}),m.keydown(function(e){e.which===CCL.CommonConstants.keyCodes.escape&&($(m).hide(),w&&w(),l.focus())}),s.shouldOpenMessagesPopUp&&(n.inboxMenuLink.click(function(e){i.isOpened()?i.closeDialog():!c||function(){if(g){return(new Date).getTime()-g.getTime()>18e4}return!1}()?f(!0):S(c)}),s.isAndroidBrowser||p.resize(I),p.on("load",function(){f()})),k(0,!1),j(0,!1),L(0,!1),b(0,!1),Q(0,!1),CommonFunctions.attachPostMessageEventListener(p,CommonWindowMessages.MessageNames.unseenNotificationCounterChanged,function(e){k(e.extendedData,e.extendedData>0)}),CommonFunctions.attachPostMessageEventListener(p,CommonWindowMessages.MessageNames.openGroupChat,function(e){if(window.itslearning.settings.app.enableModernInstantMessages)setTimeout(()=>window.dispatchEvent(new CustomEvent("openCollaborationThread",{detail:{collaborationId:e.collaborationId}})),50);else{const n="true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden"),s=jQuery("#l-header").is(":hidden");n&&"function"==typeof window.InstantMessageOpenWindowForCollaboration&&window.InstantMessageOpenWindowForCollaboration(e.collaborationId,function(){jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden")},s)}}),s.shouldOpenMessagesPopUp&&function(e){s.isModernMainMenuEnabled&&$("#OldMessages").appendTo(".personal");(i=function(e,n,s){return e.toggleElement=n,new ContextDialog(s,e)}(e,n.inboxMenuLink,n.messageDialogContent)).setBeforeCloseDialog(function(){_(n.inboxMenuLink.closest("li"),!!n.messagesBadge.text())}),i.hideHeader(),i.hideFooter(),i.toggleCloseLink(!1)}({width:400,setFocus:!1,marginTop:38,marginBottom:0,noTitle:!0,showArrow:!0,align:"center",valign:"bottom",closeButtonTooltip:u.settings.terms.close,cssClass:o.popupContainer,customScripts:{beforeCloseDialog:null}}),s.hasInternalMessages&&(r=new RegExp("[\\?&]"+s.onlineInfoCookie.unreadMessagesKey+"=([^&#]*)"))},u.setUnreadInternalMessages=function(e){s.hasInternalMessages&&e!==w&&(w=e,x())},u.setUnreadEmailMessages=function(e,n){s.hasEmail&&e!==h&&(h=e,y=n)},u.setUnreadCloudEmailMessages=function(e,n){!s.hasCloudEmail||M===e&&C===n||(M=e,C=n,T())},u.updateMessageCounterBasedOnCookie=function(){if(s.hasInternalMessages){var e=r.exec(jQuery.cookie(s.onlineInfoCookie.name));e&&e.length&&(w=parseInt(e[1]),u.setCounts())}},u.setCounts=function(){if(m&&w!==m&&u.invalidateCache(),y&&y>0&&window.itslearning.settings.app.is_instant_message_system_enabled){var e=u.controls.emailMenuLink.attr("href"),n=e.getQueryStringParameter(a.textURL);n=(n=(n=n.setQueryStringParameter(a.emailAccountsRedirect,"False")).setQueryStringParameter(a.emailRedirect,"True")).setQueryStringParameter(a.accountID,y),u.controls.emailMenuLink.attr("href",e.setQueryStringParameter(a.textURL,n))}m=w;var t=0;if(w>0&&(s.hasInternalMessages||s.hasEmail)&&(t+=w,window.itslearning.settings.app.is_instant_message_system_enabled&&(window.itslearning.instantmessaging.unreadInternalMessages=w)),(M>0||C>0)&&s.hasCloudEmail&&(window.itslearning.settings.app.is_instant_message_system_enabled?(j(M,!1),L(C,!1)):s.primaryCloudEmailType===CloudEmailType.office365?t+=M:t+=C),!window.itslearning.settings.app.is_instant_message_system_enabled&&s.hasEmail&&(t+=h),h>0&&s.hasEmail&&Q(h,h>0),(s.hasInternalMessages||s.hasCloudEmail||s.hasEmail)&&b(t,t>0||u.settings.shouldOpenMessagesPopUp&&i.isOpened()),CommonFunctions.makePostMessageCall(window.itslTop,new CommonWindowMessages.GenericMessageWithData(CommonWindowMessages.MessageNames.unseenNotificationCounterChanged,u.unseenNotifications)),window.itslearning.settings.app.is_instant_message_system_enabled){var o=jQuery.Event("UpdateUnreadMessagesCount");jQuery(window).trigger(o)}},u.invalidateCache=function(){c=void 0},u}var CloudEmailType={office365:"Office365",gmail:"Gmail"},InstantMessageSelectors={largeHeaderLogo:".l-logo",mainMenuSelector:"ul.l-main-menu-items",overlayClass:"c-messages__overlay",overlaySelector:".c-messages__overlay",overlayLargeSelector:"c-messages__overlay--largeHeader",overlayBlackClass:"c-messages__overlay--black",popupSelector:".c-messages-popup",popupIconSelector:".l-personal-menu-instantmessage",popupIconSelectedClass:"l-personal-menu-icon-instantmessage-selected"};function FlyOutPopupInit(e){jQuery(InstantMessageSelectors.popupSelector).load(e),jQuery("body").append('<div class="'+InstantMessageSelectors.overlayClass+' is-hidden"></div>'),jQuery(InstantMessageSelectors.largeHeaderLogo).length>0&&jQuery(InstantMessageSelectors.overlaySelector).addClass(InstantMessageSelectors.overlayLargeSelector),jQuery(InstantMessageSelectors.popupIconSelector).on("click",function(){var e=jQuery(this);"true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")?(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),jQuery(InstantMessageSelectors.mainMenuSelector).on("click",function(e){jQuery(InstantMessageSelectors.mainMenuSelector).off("click"),"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click()}),void 0!==window.InstantMessageOpenWindow&&window.InstantMessageOpenWindow()):jQuery(InstantMessageSelectors.overlaySelector).click(),jQuery(e).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass)}),jQuery(InstantMessageSelectors.overlaySelector).on("click",function(e){var n=jQuery(e.target);(n.hasClass(InstantMessageSelectors.overlayClass)||n.hasClass(InstantMessageSelectors.overlayBlackClass))&&(jQuery(this).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass(InstantMessageSelectors.overlayBlackClass),jQuery(InstantMessageSelectors.overlaySelector).addClass("is-hidden"),jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","true"),void 0!==window.InstantMessageCloseWindow&&window.InstantMessageCloseWindow())})}function OpenInstantMessageSendNew(e){window.itslearning.settings.app.enableModernInstantMessages?setTimeout(()=>window.dispatchEvent(new CustomEvent("showNewMessageWithPreSelectedRecipients",{detail:e})),50):void 0!==window.showInstantMessageSendNew&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.showInstantMessageSendNew(e))}function OpenInstantMessageModal(){void 0!==window.InstantMessageOpenModalWindow?openInstentMessageModalWindow():window.setTimeout(openInstentMessageModalWindow,3e3)}function openInstentMessageModalWindow(){void 0!==window.InstantMessageOpenModalWindow&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.InstantMessageOpenModalWindow())}jQuery(()=>{if(window.itslearning.settings.app.is_instant_message_system_enabled){const e=10,n="/restapi/personal/instantmessages/communicationchannel/{channelId}/v1";let s,t=0;const o=(new signalR.HubConnectionBuilder).withUrl(itslearning.settings.app.signalRUrl,{skipNegotiation:!0,transport:signalR.HttpTransportType.WebSockets}).configureLogging(signalR.LogLevel.Warning).withAutomaticReconnect().build(),a=e=>{jQuery(window).trigger(jQuery.Event("SignalRConnectionStatus"),e),window.dispatchEvent(new CustomEvent("SignalRConnectionStatus2",{detail:{status:e}}))};null!=o&&(o.on("AlertNewMessage",e=>{const n=JSON.parse(e);jQuery(window).trigger(jQuery.Event("NewSignalRInstantMessage"),n),window.dispatchEvent(new CustomEvent("NewSignalRInstantMessage2",{detail:{thread:n}}))}),o.on("AlertThreadDeleted",e=>{jQuery(window).trigger(jQuery.Event("SignalRThreadDeleted"),e)}));const i=e=>{let s="";localStorage.getItem("instantmessage-channelid")&&(s=localStorage.getItem("instantmessage-channelid"));let t=n.replace("{channelId}",e);s.length>5&&(t=`${t}?unregister=${s}`),CCL.CommonFunctions.safeAjaxPost({url:t,headers:{[itslearning.settings.app.antiForgeryHeaderName]:itslearning.settings.app.antiForgeryHeaderValue}}).done(()=>{a(!0),console.log(`SignalR connection registered. ChannelId: ${e}`),r(!1)}).fail(()=>console.log(`SignalR connection could not be registered. ChannelId: ${e}`)),localStorage.setItem("instantmessage-channelid",e)},l=()=>o.start().then(()=>o.invoke("GetConnectionId")).then(e=>i(e)).catch(e=>{a(!1),r(!0),console.log(`Error starting SignalR connection. ChannelId: ${e}`)}),r=n=>{n?t<=e&&(t+=1,window.clearInterval(s),s=window.setInterval(l,3e4)):(window.clearInterval(s),t=0)};l(),o.onreconnecting(()=>{a(!1),console.log("SignalR connection reconnecting.")}),o.onclose(()=>{a(!1),console.log("SignalR connection disconnected."),r(!0)}),o.onreconnected(()=>{console.log("SignalR connection reconnected. Trying to get ChannelId."),o.invoke("GetConnectionId").then(e=>{console.log(`SignalR connection reconnected. New ChannelId: ${e}`),i(e)})})}});