function PersonalMessagesManager(e){window[e]=this;var s,t,n,a,i,o,r,l,g=this,c=0,d=1,m=2;function u(e){return $(String.format("<div class='{0}'></div>",a.sendSuccessResult)).append(String.format("<img src='{0}' alt='' />",t.sendSuccessImageSrc)).append(String.format("<span>{0}</span>",String.format(s.messageSentTo,CCL.CommonFunctions.htmlEncode(e))))}function f(e){e.parent().find('input[type="submit"]').prop("disabled",""===e.val().trim())}function p(e,s,a,i,o,r,l,g){$.ajax({type:"POST",url:t.sendMessageUrl,data:{initialId:s,to:a,subject:i,isNewMessage:l,text:e.messageBody,messageOrigin:g},headers:n}).done(function(){e.sendMessageSuccessCallback(),o&&o()}).fail(function(e,s,t){r?r(e,s,t):CommonFunctions.alertAjaxError()}).always(function(){e.sendMessageCompleteCallback()})}function v(e,s){var t=e.closest("li."+a.messageItem),n={lastItemDeleted:!1,updateCounter:s===c||s===d};s===c?(0===t.siblings("li."+a.messageItem).length&&(n.lastItemDeleted=!0),t.remove()):t.removeClass(a.unreadMessageItem),g.callbacks.onMessageAction&&g.callbacks.onMessageAction(n)}return g.callbacks={},g.initialize=function(){s=g.settings.terms,t=g.settings.urls;var e={};e[g.settings.antiforgery.HeaderName]=g.settings.antiforgery.HeaderValue,n=e,a=g.settings.cssClasses,r=g.settings.messageOrigins,l=g.settings.kpi,i=g.settings.clientIds,g.settings.clientInstanceNames.participantsInputClientInstanceName&&(o=g.settings.clientInstanceNames.participantsInputClientInstanceName),setTimeout(function(){$("."+a.messageItem).each(function(){var e=$(this);e.find(String.format(".{0} a",a.textToggle)).on(g.settings.clickOrTouch,function(){var t=e.find("."+a.text).get(0),n=$(t);return n.hasClass(a.collapsed)?(n.removeClass(a.collapsed),$(this).text(s.showLess)):(n.addClass(a.collapsed),$(this).text(s.showMore)),!1})}).on("keyup","."+a.sendMessageInlineReply+" textarea",function(e){f($(e.target))})},0),$("."+a.messageItem).find("."+a.sendMessageInlineReply).hide()},g.toggleNewMessage=function(e,s){e.toggle(),e.is(":visible")&&(window[o].focus(),s==r.dropDown&&CommonFunctions.measureKpi(l.url,l.section,l.measurements.createNewMessage,l.context))},g.toggleMessage=function(e,i,o,g){var c=i.closest("li."+a.messageItem),m=i.find("."+a.text),u=i.find("."+a.textToggle);if(c.find(String.format(".{0} .{1}",a.head,a.subject)).toggleClass(a.collapsed),function(e,s){var t=e.find("*[data-"+s+"]");if(t.length>0){var n=$("<div></div>").html(t.data(s));t.prepend(n),t.removeAttr("data-"+s)}}(i,"message-text"),i.toggle(),i.is(":visible")){o===r.dropDown&&CommonFunctions.measureKpi(l.url,l.section,l.measurements.viewMessage,l.context),c.hasClass(a.unreadMessageItem)&&function(e,s,a){$.ajax({type:"PUT",url:t.markMessageAsReadUrl.replace("(messageId)",e).replace("(messageOrigin)",a),data:{MessageId:e,IsRead:!0},headers:n}).done(function(){v(s,d)}).fail(CommonFunctions.alertAjaxError)}(e,i,o);var f=m.find("div").height();m.toggleClass(a.collapsed,f>=130),u.toggle(f>=130),function(e,s){var n=s.find("."+a.attachmentsContainer);n.length>0&&0===n.find("ul").length&&$.ajax({type:"GET",url:t.getAttachmentsUrl,data:{messageId:e},success:function(e){n.append(e)},error:CommonFunctions.alertAjaxError})}(e,c),g.length&&g.is(":visible")&&g.find("textarea").focus()}else m.toggleClass(a.collapsed,!0),u.find("a").text(s.showMore)},g.toggleReplyMessage=function(e,s){e.toggle();var t=e.find("textarea");f(t),e.is(":visible")&&(t.focus(),s==r.dropDown&&CommonFunctions.measureKpi(l.url,l.section,l.measurements.replyToMessage,l.context))},g.deleteMessage=function(e,a,i){confirm(s.deleteConfirmation)&&$.ajax({type:"DELETE",url:t.deleteMessageUrl.replace("(messageId)",e).replace("(messageOrigin)",i),headers:n}).done(function(){v(a,c)}).fail(CommonFunctions.alertAjaxError)},g.sendMessage=function(e,s,t,n,i,o,r,l){p(e,t,n,o,function(){l();var e=$("#"+s);e.after(function(){return u(i)}),e.next("."+a.sendSuccessResult).delay(2e3).fadeOut(300).promise().done(function(){$(this).remove()})},void 0,!1,r)},g.sendQuickMessage=function(e,t,n,i,r,l,c,d,m){var f=window[o],v=$("#"+t),h=$("#"+n),C=$("#"+r);if(f.hasText())return C.show(),$("#"+l).html(s.messagingValidationInvalidRecipients+"<br />"+f.getText()),void e.sendMessageCompleteCallback();p(e,-1,f.mapLabelsField("UserName").join(),v.val(),function(){i(),C.hide(),h.after(u(f.mapLabelsField("Name").join(", "))),h.next("."+a.sendSuccessResult).delay(2e3).fadeOut(300).promise().done(function(){g.toggleControlsWhenNewMessage(!1),$("#"+c).toggle(),$(this).remove()}),f.clear(),v.val(""),d()},function(){var e;i(),C.hide(),h.after((e=i,$(String.format("<div class='{0}'></div>",a.sendFailedResult)).append("<span>"+s.failedToSendMessage+"</span>").append($("<a href='#'>"+s.retrySend+"</a>").on(g.settings.clickOrTouch,function(s){e(),s.preventDefault(),$(this).parent().remove()}))))},!0,m)},g.toggleFavoriteMessage=function(e,i,o){var r=i.prev("input[type=hidden]"),l=1===parseInt(r.val());$.ajax({type:"POST",url:t.toggleFavoriteMessageUrl.replace("(messageId)",e).replace("(isFavorite)",!l).replace("(messageOrigin)",o),headers:n}).done(function(){i.prop("title",l?s.addToFavorite:s.removeFromFavorite),i.children("img").toggleClass(a.favorite,!l).toggleClass(a.notFavorite,l),r.val(l?0:1),v(i,m)}).fail(CommonFunctions.alertAjaxError)},g.toggleControlsWhenNewMessage=function(e){var s=$("."+a.messageItem);if(s.toggle(!e),i.emptyMessageContainer&&$("#"+i.emptyMessageContainer).toggle(0==s.length&&!e),i.cloudInboxContainer&&$("#"+i.cloudInboxContainer).toggle(!e),i.messagesLink){var t=$("#"+i.messagesLink);t.toggle(!e,function(){t.is(":visible")&&t.css("display","inline-block")})}},g}